"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[381],{4381:function(e,r,t){t.d(r,{bG:function(){return g},dz:function(){return o},ky:function(){return s},nY:function(){return l},t:function(){return c},u1:function(){return u}});var a=t(5526),n=t(3837),i=t(7024);async function o(e){let r=(0,n.Z)(),t=(0,n.Z)(),i="user_".concat(Math.random().toString(36).substring(2,9));try{let{data:n,error:o}=await a.O.from("games").insert({id:r,status:"waiting",current_turn:null,betting_value:0,winner:null}).select();if(o)throw console.error("게임 생성 오류 세부 정보:",o),Error("게임을 생성할 수 없습니다: "+o.message);console.log("게임 생성 성공:",r);let{data:l,error:s}=await a.O.from("players").insert({id:t,game_id:r,user_id:i,username:e,balance:1e4,is_die:!1}).select();if(s)throw console.error("플레이어 생성 오류 세부 정보:",s),Error("플레이어를 생성할 수 없습니다: "+s.message);return console.log("플레이어 생성 성공:",t),localStorage.setItem("game_".concat(r,"_user_id"),i),localStorage.setItem("game_".concat(r,"_player_id"),t),{gameId:r,playerId:t}}catch(e){throw console.error("게임 생성 중 예외 발생:",e),e}}async function l(e,r){try{let{data:t,error:i}=await a.O.from("games").select("*").eq("id",e).single();if(i||!t)throw console.error("게임 조회 오류 세부 정보:",i),Error("게임을 찾을 수 없습니다: "+((null==i?void 0:i.message)||"알 수 없는 오류"));let o=localStorage.getItem("game_".concat(e,"_user_id")),l=localStorage.getItem("game_".concat(e,"_player_id"));if(o&&l){let{data:t,error:n}=await a.O.from("players").select("*").eq("game_id",e).eq("id",l).single();if(!n&&t){console.log("기존 플레이어로 재접속:",t.id),t.username!==r&&await a.O.from("players").update({username:r}).eq("id",t.id);let n=await s(e);return{playerId:t.id,gameState:n,rejoined:!0}}}if("waiting"!==t.status)throw Error("이미 시작된 게임에는 참가할 수 없습니다.");let c=(0,n.Z)(),u="user_".concat(Math.random().toString(36).substring(2,9)),{data:d,error:f}=await a.O.from("players").insert({id:c,game_id:e,user_id:u,username:r,balance:1e4,is_die:!1}).select();if(f)throw console.error("플레이어 생성 오류 세부 정보:",f),Error("게임에 참가할 수 없습니다: "+f.message);console.log("플레이어 참가 성공:",c),localStorage.setItem("game_".concat(e,"_user_id"),u),localStorage.setItem("game_".concat(e,"_player_id"),c);let g=await s(e);return{playerId:c,gameState:g}}catch(e){throw console.error("게임 참가 중 예외 발생:",e),e}}async function s(e){let r;let{data:t,error:n}=await a.O.from("games").select("*").eq("id",e).single();if(n||!t)throw console.error("게임 조회 오류:",n),Error("게임을 찾을 수 없습니다.");let{data:i,error:o}=await a.O.from("players").select("*").eq("game_id",e);if(o)throw console.error("플레이어 조회 오류:",o),Error("플레이어 정보를 불러올 수 없습니다.");if("regame"===t.status&&t.regame_start_time&&t.regame_wait_time){let e=new Date(t.regame_start_time).getTime(),a=new Date().getTime();r=Math.ceil(Math.max(0,t.regame_wait_time-(a-e))/1e3)}return{id:t.id,status:t.status,players:i.map(e=>({id:e.id,user_id:e.user_id,username:e.username,balance:e.balance,cards:e.cards||[],isDie:e.is_die})),currentTurn:t.current_turn||"",winner:t.winner,bettingValue:t.betting_value,regame_remaining_time:r,regame_start_time:t.regame_start_time}}async function c(e){let{data:r,error:t}=await a.O.from("players").select("id").eq("game_id",e);if(t||!r||r.length<2)throw Error("최소 2명의 플레이어가 필요합니다.");let n=function(){let e=Array.from({length:20},(e,r)=>r+1);for(let r=e.length-1;r>0;r--){let t=Math.floor(Math.random()*(r+1));[e[r],e[t]]=[e[t],e[r]]}return e}();for(let e=0;e<r.length;e++){let t=[n.pop(),n.pop()].filter(Boolean),{error:i}=await a.O.from("players").update({cards:t}).eq("id",r[e].id);if(i)throw console.error("플레이어 카드 업데이트 오류:",i),Error("카드를 배분할 수 없습니다.")}let i=r[Math.floor(Math.random()*r.length)].id,{error:o}=await a.O.from("games").update({status:"playing",current_turn:i,betting_value:0}).eq("id",e);if(o)throw console.error("게임 상태 업데이트 오류:",o),Error("게임을 시작할 수 없습니다.");await m(e,"start",i)}async function u(e,r,t,n){let i=await s(e);if("playing"!==i.status)throw Error("게임이 진행 중이 아닙니다.");if(i.currentTurn!==r)throw Error("당신의 턴이 아닙니다.");let o=i.players.find(e=>e.id===r);if(!o)throw Error("플레이어를 찾을 수 없습니다.");let{data:l,error:c}=await a.O.from("game_actions").select("*").eq("game_id",e).order("created_at",{ascending:!1}).limit(10);if(c)throw console.error("게임 액션 조회 오류:",c),Error("게임 액션을 조회할 수 없습니다.");let u=null==l?void 0:l.find(e=>["bet","raise","call","half"].includes(e.action_type)&&e.player_id!==r),g=0,h=i.baseBet||500;switch(t){case"check":if(u&&u.amount>0)throw Error("이전 베팅이 있어 체크할 수 없습니다.");g=0;break;case"call":g=(null==u?void 0:u.amount)||h;break;case"half":g=(g=Math.floor(i.bettingValue/2))<h?h:g;break;case"bet":case"raise":if(!n||n<=0)throw Error("베팅 금액은 0보다 커야 합니다.");let p=u?2*u.amount:h;if(n<p)throw Error("최소 베팅액은 ".concat(p,"입니다."));g=n;break;case"die":g=0;break;default:throw Error("잘못된 액션 타입입니다.")}if("die"!==t&&o.balance<g)throw Error("잔액이 부족합니다.");if("die"===t){let{error:t}=await a.O.from("players").update({is_die:!0}).eq("id",r);if(t)throw console.error("플레이어 다이 상태 업데이트 오류:",t),Error("다이할 수 없습니다.");let n=i.players.filter(e=>e.id!==r&&!e.isDie);if(1===n.length){let t=n[0].id,{error:o}=await a.O.from("players").update({balance:n[0].balance+i.bettingValue}).eq("id",t);if(o)throw console.error("승자 잔액 업데이트 오류:",o),Error("승자 잔액을 업데이트할 수 없습니다.");let{error:l}=await a.O.from("games").update({status:"finished",winner:t}).eq("id",e);if(l)throw console.error("게임 종료 상태 업데이트 오류:",l),Error("게임을 종료할 수 없습니다.");await m(e,"die",r);return}{let t=f(i.players,r),{error:n}=await a.O.from("games").update({current_turn:t}).eq("id",e);if(n)throw console.error("게임 상태 업데이트 오류:",n),Error("게임 상태를 업데이트할 수 없습니다.");await m(e,"die",r);return}}let k=f(i.players,r),{error:y}=await a.O.from("games").update({current_turn:k,betting_value:i.bettingValue+g}).eq("id",e);if(y)throw console.error("게임 상태 업데이트 오류:",y),Error("베팅할 수 없습니다.");if(g>0){let{error:e}=await a.O.from("players").update({balance:o.balance-g}).eq("id",r);if(e)throw console.error("플레이어 잔액 업데이트 오류:",e),Error("잔액을 업데이트할 수 없습니다.")}let b=await w(e,i.players),v=await d(e,i.players);b&&v?(console.log("모든 플레이어 액션 완료, 베팅 금액 일치 - 게임 종료"),await _(e)):(b||console.log("아직 모든 플레이어가 액션을 취하지 않음"),v||console.log("플레이어들의 베팅 금액이 일치하지 않음")),await m(e,t,r,g)}async function d(e,r){let t=r.filter(e=>!e.isDie);if(t.length<=1)return!0;let n={};for(let r of t){let{data:t,error:i}=await a.O.from("game_actions").select("*").eq("game_id",e).eq("player_id",r.id).in("action_type",["bet","call","raise","half","check"]).order("created_at",{ascending:!1}).limit(1);if(i||!t||0===t.length)return!1;n[r.id]=t[0].amount||0}let i=Object.values(n);return i.every(e=>e===i[0])}function f(e,r){let t=e.filter(e=>!e.isDie);if(t.length<=1)return"";let a=(t.findIndex(e=>e.id===r)+1)%t.length;return t[a].id}async function g(e,r,t){if(!t.trim())throw Error("메시지 내용이 비어있습니다.");let{data:i,error:o}=await a.O.from("players").select("username, user_id").eq("id",r).single();if(o||!i)throw console.error("플레이어 정보 조회 오류:",o),Error("플레이어 정보를 찾을 수 없습니다.");let l=(0,n.Z)(),s=new Date().toISOString(),c={id:l,game_id:e,user_id:i.user_id,username:i.username,content:t,created_at:s},{error:u}=await a.O.from("messages").insert(c);if(u)throw console.error("메시지 저장 오류:",u),Error("메시지를 전송할 수 없습니다: "+u.message)}async function m(e,r,t,n){let{error:i}=await a.O.from("game_actions").insert({game_id:e,player_id:t,action_type:r,amount:n});i&&(console.error("게임 액션 기록 오류:",i),console.warn("게임 액션을 기록할 수 없습니다."))}async function w(e,r){let t=r.filter(e=>!e.isDie),n=new Set,{data:i,error:o}=await a.O.from("game_actions").select("created_at").eq("game_id",e).eq("action_type","start").order("created_at",{ascending:!1}).limit(1);if(o)return console.error("게임 시작 액션 조회 오류:",o),!1;let l=i&&i.length>0?i[0].created_at:new Date(0).toISOString();for(let r of t){let{data:t,error:i}=await a.O.from("game_actions").select("player_id").eq("game_id",e).eq("player_id",r.id).in("action_type",["bet","call","raise","half","check","die"]).gt("created_at",l).order("created_at",{ascending:!1}).limit(1);if(i||!t||0===t.length)return!1;n.add(r.id)}return n.size===t.length}async function _(e){let r=await s(e),t=r.players.filter(e=>!e.isDie&&e.cards&&2===e.cards.length).map(e=>({id:e.id,cards:e.cards,isDie:e.isDie||!1}));if(0===t.length){console.error("활성 플레이어가 없습니다");return}let{winnerId:n,isRegame:o}=(0,i.M2)(t);if(o){await h(e);return}if(!n){console.log("승자를 결정할 수 없음 (구사 등의 특수 상황)");return}let l=r.players.find(e=>e.id===n);if(!l){console.error("승자 정보를 찾을 수 없음");return}let c=r.bettingValue,u={};for(let e of r.players.filter(e=>!e.isDie&&e.id!==n)){let t=(0,i.z0)(l.cards||[]),a=(0,i.z0)(e.cards||[]);if("땡잡이"===t.rank&&a.rank.includes("땡")&&!a.rank.includes("광땡")&&"10땡"!==a.rank){var d,f;let t=(d=a.rank,f=r.bettingValue,"38광땡"===d?10*f:"13광땡"===d?8*f:"18광땡"===d?7*f:"10땡"===d||"장땡"===d?5*f:"9땡"===d?4.5*f:"8땡"===d?4*f:"7땡"===d?3.5*f:"6땡"===d?3*f:"5땡"===d?2.5*f:"4땡"===d?2*f:"3땡"===d?1.5*f:"2땡"===d?1.25*f:"1땡"===d?1*f:"암행어사"===d?3*f:0);u[e.id]=t,c+=t}if("암행어사"===t.rank&&("13광땡"===a.rank||"18광땡"===a.rank)){let t=3*r.bettingValue;u[e.id]=t,c+=t}if("38광땡"===t.rank&&("13광땡"===a.rank||"18광땡"===a.rank)){let t=2*r.bettingValue;u[e.id]=t,c+=t}}let{error:g}=await a.O.from("players").update({balance:l.balance+c}).eq("id",n);if(g)throw console.error("승자 잔액 업데이트 오류:",g),Error("승자 잔액을 업데이트할 수 없습니다.");for(let[e,t]of Object.entries(u)){let n=r.players.find(r=>r.id===e);if(n){let{error:r}=await a.O.from("players").update({balance:Math.max(0,n.balance-t)}).eq("id",e);r&&console.error("패자 잔액 업데이트 오류:",r)}}let{error:w}=await a.O.from("games").update({status:"finished",winner:n,show_cards:!0,dang_values:u}).eq("id",e);if(w)throw console.error("게임 종료 상태 업데이트 오류:",w),Error("게임을 종료할 수 없습니다.");await m(e,"show",n)}async function h(e){for(let r of(await s(e)).players){let{error:e}=await a.O.from("players").update({cards:null,is_die:!1}).eq("id",r.id);e&&console.error("플레이어 카드 초기화 오류:",e)}let{error:r}=await a.O.from("games").update({status:"regame",current_turn:null,winner:null,regame_start_time:new Date().toISOString(),regame_wait_time:5e3}).eq("id",e);if(r)throw console.error("재경기 설정 오류:",r),Error("재경기를 설정할 수 없습니다.");await m(e,"regame",null);let t=Math.floor(5),n=setInterval(async()=>{t--,await a.O.from("games").update({regame_remaining_time:t}).eq("id",e),t<=0&&clearInterval(n)},1e3);setTimeout(async()=>{try{clearInterval(n),await c(e)}catch(e){console.error("재경기 시작 오류:",e)}},5e3)}},5526:function(e,r,t){t.d(r,{O:function(){return a}});let a=(0,t(3777).eI)("https://ftzxcbarjntphlwmincc.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0enhjYmFyam50cGhsd21pbmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIzNzk5OTAsImV4cCI6MjA1Nzk1NTk5MH0.h8y5X3kCGJgvVf-_EA4jOyjU-4Z5q24GHklQZgrocY4",{realtime:{params:{eventsPerSecond:20}},auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!1},global:{fetch:fetch.bind(globalThis)}})},7024:function(e,r,t){t.d(r,{M2:function(){return l},g9:function(){return n},gr:function(){return i},z0:function(){return o}});let a=new Map;function n(e){return Math.ceil(e/2)}function i(e){return e%2==1&&e<=5}function o(e){if(!e||2!==e.length)return console.error("유효하지 않은 카드 조합:",e),{cards:e||[],rank:"망통",value:0};let r=e.sort((e,r)=>e-r).join("-"),t=a.get(r);if(t)return t;try{let[t,o]=[...e].sort((e,r)=>e-r),l=n(t),s=n(o),c=i(t),u=i(o),d=t%2==0,f=o%2==0;if(3===l&&8===s&&c&&u){let t={cards:e,rank:"38광땡",value:2e3};return a.set(r,t),t}if(1===l&&3===s&&c&&u){let t={cards:e,rank:"13광땡",value:1900};return a.set(r,t),t}if(1===l&&8===s&&c&&u){let t={cards:e,rank:"18광땡",value:1800};return a.set(r,t),t}if(4===l&&7===s&&d&&f){let t={cards:e,rank:"암행어사",value:1700};return a.set(r,t),t}if(3===l&&7===s&&d&&f){let t={cards:e,rank:"땡잡이",value:1600};return a.set(r,t),t}if(4===l&&9===s&&d&&f){console.log("멍텅구리구사 발생: 4월 열끗 + 9월 열끗");let t={cards:e,rank:"멍텅구리구사",value:-100};return a.set(r,t),t}if((4===l&&9===s||9===l&&4===s)&&!(4===l&&9===s&&d&&f)){console.log("구사 발생: 4월 + 9월 (열끗 아닌 조합)");let t={cards:e,rank:"구사",value:-200};return a.set(r,t),t}if(l===s){if(10===l){let t={cards:e,rank:"10땡",value:1500};return a.set(r,t),t}let t={cards:e,rank:"".concat(l,"땡"),value:1400+10*l};return a.set(r,t),t}if(1===l&&2===s||2===l&&1===s){let t={cards:e,rank:"알리",value:800};return a.set(r,t),t}if(1===l&&4===s||4===l&&1===s){let t={cards:e,rank:"독사",value:700};return a.set(r,t),t}if(1===l&&9===s||9===l&&1===s){let t={cards:e,rank:"구삥",value:600};return a.set(r,t),t}if(1===l&&10===s||10===l&&1===s){let t={cards:e,rank:"장삥",value:500};return a.set(r,t),t}if(4===l&&10===s||10===l&&4===s){let t={cards:e,rank:"장사",value:400};return a.set(r,t),t}if(4===l&&6===s||6===l&&4===s){let t={cards:e,rank:"세륙",value:300};return a.set(r,t),t}let g=(l+s)%10;if(9===g){let t={cards:e,rank:"갑오",value:250};return a.set(r,t),t}if(g>0){let t={cards:e,rank:"".concat(g,"끗"),value:100+10*g};return a.set(r,t),t}let m={cards:e,rank:"망통",value:50};return a.set(r,m),m}catch(r){return console.error("카드 평가 중 오류 발생:",r,e),{cards:e,rank:"망통",value:0}}}function l(e){let r=e.filter(e=>!e.isDie);if(0===r.length)return{winnerId:null,isRegame:!1};if(1===r.length)return{winnerId:r[0].id,isRegame:!1};let t=r.filter(e=>"구사"===o(e.cards).rank),a=r.filter(e=>"멍텅구리구사"===o(e.cards).rank);if(t.length>0){let e=r.filter(e=>"구사"!==o(e.cards).rank).sort((e,r)=>{let t=o(e.cards);return o(r.cards).value-t.value})[0];if(e&&o(e.cards).value<=800)return console.log("구사 발생, 최고 패가 알리 이하이므로 재경기"),{winnerId:null,isRegame:!0}}if(a.length>0){let e=r.filter(e=>"멍텅구리구사"!==o(e.cards).rank).sort((e,r)=>{let t=o(e.cards);return o(r.cards).value-t.value})[0];if(e&&o(e.cards).value<=1500)return console.log("멍텅구리 구사 발생, 최고 패가 장땡 이하이므로 재경기"),{winnerId:null,isRegame:!0}}let n=r[0].id,i=r[0].cards;o(i);let l={};r.forEach((e,r)=>{l[e.id]=r});for(let e=1;e<r.length;e++){let t=function(e,r){let t=o(e),a=o(r);return(console.log("패 비교:",t.rank,"(값:",t.value,") vs",a.rank,"(값:",a.value,")"),"구사"===t.rank||"멍텅구리구사"===t.rank||"구사"===a.rank||"멍텅구리구사"===a.rank)?0:"암행어사"===t.rank&&("13광땡"===a.rank||"18광땡"===a.rank)?(console.log("암행어사가 광땡을 이김"),1):"암행어사"===a.rank&&("13광땡"===t.rank||"18광땡"===t.rank)?(console.log("암행어사가 광땡을 이김"),2):"땡잡이"===t.rank&&a.rank.includes("땡")&&"10땡"!==a.rank&&!a.rank.includes("광땡")?(console.log("땡잡이가 일반 땡을 이김"),1):"땡잡이"===a.rank&&t.rank.includes("땡")&&"10땡"!==t.rank&&!t.rank.includes("광땡")?(console.log("땡잡이가 일반 땡을 이김"),2):t.value>a.value?1:t.value<a.value?2:0}(i,r[e].cards);2===t?(n=r[e].id,o(i=r[e].cards)):0===t&&l[r[e].id]<l[n]&&(n=r[e].id,o(i=r[e].cards))}return{winnerId:n,isRegame:!1}}}}]);